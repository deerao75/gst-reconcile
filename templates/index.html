{% extends "base.html" %}
{% block content %}

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<div class="main-layout-wrapper">

  <aside class="consolidation-sidebar">

    <div class="consolidation-box">
      <h3 style="color: #ff9500;">Consolidate GSTR-2B</h3>
      <p class="hint">If you have multiple GSTR 2B files or wish to run reco for multiple registrations at once, merge the files into one file before upload.</p>
      <form id="form-2b" action="{{ url_for('consolidate_files') }}" method="post" enctype="multipart/form-data" onsubmit="handleConsolidation(event, this)">
        <label class="filebtn" style="width: 100%; margin-bottom: 10px;">
          Select Files
          <input type="file" name="files" multiple accept=".xls,.xlsx" onchange="updateFileCount(this)">
        </label>
        <p class="upload-confirm" style="margin-top:0; margin-bottom:10px; font-size: 0.85rem; min-height: 1.2em;"></p>
        <button type="submit" class="cta" style="width: 100%; padding: 10px; font-size: 0.9rem;">Consolidate</button>
      </form>
    </div>

    <div class="consolidation-box">
      <h3 style="color: #ff9500;">Consolidate PR</h3>
      <p class="hint">If you have multiple Purchase Register files or wish to run reco for multiple registrations at once, merge the files into one file before upload.</p>
      <form id="form-pr" action="{{ url_for('consolidate_files') }}" method="post" enctype="multipart/form-data" onsubmit="handleConsolidation(event, this)">
        <label class="filebtn" style="width: 100%; margin-bottom: 10px;">
          Select Files
          <input type="file" name="files" multiple accept=".xls,.xlsx" onchange="updateFileCount(this)">
        </label>
        <p class="upload-confirm" style="margin-top:0; margin-bottom:10px; font-size: 0.85rem; min-height: 1.2em;"></p>
        <button type="submit" class="cta" style="width: 100%; padding: 10px; font-size: 0.9rem;">Consolidate</button>
      </form>
    </div>

  </aside>

  <section class="panel">
    <h1 style="text-align: center; color: #ff9500;">Acer Nova (Beta Version)</h1>
    <h2 style="text-align: center;">GST Reconciliation - Purchase Register vs. GSTR 2B</h2>
    <p class="muted" style="text-align: justify;">
    Upload your GSTR-2B and Purchase Register. For GSTR-2B, please specify if it's the original file from the GST Portal or a custom file with headers in the first row. The program will automatically identify and suggest columns for mapping. After uploading, click the button to proceed to the verification step.
    </p>

    <form class="upload-form" action="{{ url_for('verify_columns') }}" method="post" enctype="multipart/form-data">
      <div class="upload-grid">
        <div class="upload-box">
          <h3>GSTR-2B</h3>
          <p class="hint">Reads <b>B2B</b> &amp; <b>B2B-CDNR</b> sheets.</p>
          <label class="filebtn">
            Choose File
            <input id="file2b" type="file" name="gstr2b" accept=".xls,.xlsx">
          </label>
          <p id="file2bName" class="upload-confirm"></p>
        </div>

        <div class="upload-box">
          <h3>Purchase Register</h3>
          <p class="hint">Requires .xlsx or .xls file.</p>
          <label class="filebtn">
            Choose File
            <input id="filepr" type="file" name="purchase_register" accept=".xls,.xlsx">
          </label>
          <p id="fileprName" class="upload-confirm"></p>
        </div>
      </div>

      <div class="format-selector-box">
          <h4>GSTR-2B Format</h4>
          <p class="hint">Select the header format of your GSTR-2B file.</p>
          <div class="radio-group">
              <label>
                  <input type="radio" name="gstr2b_format" value="portal" checked>
                  Portal Format (Headers on Rows 5 & 6)
              </label>
              <label>
                  <input type="radio" name="gstr2b_format" value="custom">
                  Custom Format (Headers on Row 1)
              </label>
          </div>
      </div>

      <div class="upload-actions">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button type="button" id="instruction-btn" class="cta cta-secondary">Instructions for file upload</button>
          <button type="button" id="custom-format-btn" class="cta cta-secondary">Custom Format (download)</button>
        </div>
        <button type="submit" class="cta">Verify and Reconcile</button>
      </div>
    </form>
  </section>

  <aside class="remarks-sidebar">
    <div class="remark-box">
      <h3>Mapping Remarks Explained</h3>
      <ul>
        <li><b>Matched:</b> GSTIN and Invoice Number are concatenated to form a unique key after accounting for all the typo/syntax errors. If these match between PR and 2B and all other fields (CGST, SGST, IGST, Date) also align, the record is marked as <span class="matched">Matched</span>.</li>
        <li><b>Almost Matched:</b> GSTIN + Invoice Number match, but one or more other fields (such as GSTIN, tax amounts or date) differ slightly. These are marked as <span class="almost">Almost Matched</span> for further review.</li>
        <li><b>Not Matched:</b> The record exists only on one side or have significant differences are noted as either <span class="missing">Missing in GSTR-2B</span> or <span class="missing">Missing in Purchase Register</span>.</li>
      </ul>
    </div>
  </aside>

</div>

<div id="instruction-modal" class="instruction-modal">
  <div class="instruction-modal-content">
    <span class="instruction-modal-close-btn" id="inst-close-x">&times;</span>
    <h2>File Upload Instructions</h2>
    <p>To ensure the highest accuracy, please prepare your files according to the guidelines below.</p>
    <hr>
    <h3>GSTR-2B File Requirements</h3>
    <p>You have two options for your GSTR-2B file. Please select the correct format on the upload page:</p>
    <ul>
        <li><strong>GST Portal Format:</strong> Use the original, unmodified Excel file from the GST Portal where headers are on rows 5 and 6.</li>
        <li><strong>Custom Format:</strong> If using a modified file, ensure to upload the 2B file as per the format provided and with headings in <strong>first row</strong>.</li>
    </ul>
    <p>For both formats, your file must contain sheets named exactly <strong>"B2B"</strong> and/or <strong>"B2B-CDNR"</strong>.</p>
    <h3>Purchase Register (PR) File Requirements</h3>
    <ul>
        <li><strong>File Type:</strong> Must be an Excel file (.xlsx or .xls).</li>
        <li><strong>Headers:</strong> Use simple, clear, and generic headers in the <strong>first row</strong> (e.g., "Invoice Number", "Supplier GSTIN", "Invoice Date", "CGST").</li>
        <li><strong>Essential Data:</strong> The file must contain columns for the supplier's GSTIN, invoice number, invoice date, taxable value, and CGST, SGST and IGST amounts.</li>
    </ul>
    <h3>General Tips for Data Accuracy</h3>
    <ul>
      <li><strong>Date Format:</strong> Ensure all dates are in the <strong>DD-MM-YYYY</strong> format (e.g., 25-11-2025) for best results.</li>
      <li><strong>Clean Numeric Values:</strong> All monetary columns (Taxable Value, CGST, etc.) must contain only numbers. Remove currency symbols (₹), commas, and text.</li>
      <li><strong>Correct GSTINs:</strong> Double-check that all GSTINs are in the correct 15-character format without extra spaces or special characters.</li>
    </ul>
    <button type="button" class="instruction-modal-close-cta" id="inst-close-btn">Close</button>
  </div>
</div>

<div id="custom-format-modal" class="instruction-modal">
  <div class="instruction-modal-content">
    <span class="instruction-modal-close-btn" id="custom-close-x">&times;</span>
    <h2>Custom GSTR-2B Format Instructions</h2>
    <p>If you are using the Custom Format option, please follow these strict guidelines:</p>
    <hr>
    <h3>How to fill the data:</h3>
    <ul>
        <li><strong>Unified Data:</strong> All Invoices, Credit Notes, Debit Notes, and Import of Goods data, if any, must be uploaded in a single Excel sheet.</li>
        <li><strong>Sheet Name:</strong> The data must be placed in a specific sheet named exactly <strong>"B2B"</strong>.</li>
        <li><strong>Headers:</strong> Please use the attached format. Do not change the header names in the first row.</li>
    </ul>
    <div style="background: #e9ecef; padding: 20px; border-radius: 8px; margin-top: 25px; text-align: center; border: 1px dashed #ccc;">
        <p style="margin-top: 0; margin-bottom: 15px; font-weight: 600; color: #333;">Download the Excel Template:</p>
        <a href="{{ url_for('static', filename='custom_gstr2b_format.xlsx') }}" class="cta" style="text-decoration: none; display: inline-block; background-color: #ffb74d; border-color: #ffb74d; color: #000; font-weight: 600;" download>
            Download Custom Format (.xlsx)
        </a>
    </div>
    <button type="button" class="instruction-modal-close-cta" id="custom-close-btn">Close</button>
  </div>
</div>

<div id="validation-modal" class="instruction-modal">
  <div class="instruction-modal-content" style="max-width: 500px; text-align: center;">
    <h2 style="color: #000; margin-top: 0;">Files Missing</h2>
    <p style="font-size: 1.1rem; margin: 20px 0; text-align: center;">
        Please upload both the <b>GSTR-2B</b> and <b>Purchase Register</b> files to proceed.
    </p>
    <hr>
    <button type="button" class="instruction-modal-close-cta" id="validation-ok-btn" style="background-color: #ffb74d; color: #000; font-weight: 600; width: 120px; margin: 0 auto;">OK</button>
  </div>
</div>

<div id="message-modal" class="instruction-modal">
  <div class="instruction-modal-content" style="max-width: 500px; text-align: center;">
    <h2 id="msg-modal-title" style="color: #000; margin-top: 0;">Notice</h2>
    <p id="msg-modal-text" style="font-size: 1.1rem; margin: 20px 0; text-align: center; color: #333;"></p>
    <hr>
    <button type="button" class="instruction-modal-close-cta" id="msg-modal-ok-btn" style="background-color: #ffb74d; color: #000; font-weight: 600; width: 120px; margin: 0 auto;">OK</button>
  </div>
</div>

<div id="confirmation-modal" class="instruction-modal">
  <div class="instruction-modal-content" style="max-width: 500px; text-align: center;">
    <h2 style="color: #000; margin-top: 0;">Confirm Consolidation</h2>
    <p id="conf-modal-text" style="font-size: 1.1rem; margin: 20px 0; text-align: center; color: #333;"></p>
    <hr>
    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
        <button type="button" class="cta" id="conf-modal-cancel-btn" style="background-color: #e0e0e0; color: #000; font-weight: 600; width: 120px; border: 1px solid #ccc;">Cancel</button>
        <button type="button" class="cta" id="conf-modal-ok-btn" style="background-color: #ffb74d; color: #000; font-weight: 600; width: 120px; border-color: #ffb74d;">OK</button>
    </div>
  </div>
</div>

<div id="processingOverlay" role="status" aria-hidden="true" aria-live="polite">
  <div class="processing-box" role="dialog" aria-modal="true">

    <div class="processing-spinner" id="proc-spinner" aria-hidden="true"></div>

    <div class="processing-text">
      <div class="processing-title" id="proc-title">Processing Request</div>
      <div class="processing-sub" id="proc-sub">Please wait...</div>

      <div id="proc-stats" style="display:none; margin-top: 15px; font-size: 1rem; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 6px; color: #333; width: 100%; border: 1px solid #ddd;"></div>

      <div id="proc-close-container" style="display:none; margin-top: 25px; text-align: center;">
        <button type="button" class="cta" onclick="closeConsolidationOverlay()" style="min-width: 150px; background-color: #000; border-color: #000; color: #fff;">Close & Reset</button>
      </div>
    </div>
  </div>
</div>


<style>
/* 1. LAYOUT STYLES - Flexbox Centering */
.main-layout-wrapper {
  width: 98vw;
  position: relative;
  left: 50%;
  transform: translateX(-50%);

  /* Flex Layout */
  display: flex;
  flex-direction: row;
  justify-content: center; /* This centers the (Sidebar + Panel + Sidebar) group */
  align-items: flex-start;
  gap: 30px;
}

/* 2. SIDEBAR STYLES (Both Left and Right) */
.consolidation-sidebar, .remarks-sidebar {
  width: 320px; /* Fixed Width for perfect balance */
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* 3. CONSOLIDATION BOXES - DARK THEME */
.consolidation-box {
  background: #1f1f1f;
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 12px;
  padding: 1.2rem 1.5rem;
  text-align: center;
  color: #fff;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.consolidation-box h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.2rem; }
.consolidation-box .hint { font-size: 0.9rem; color: #ccc; margin-bottom: 15px; }

/* 4. MAIN PANEL CONTROLLER */
section.panel {
  flex-grow: 0;
  flex-shrink: 0;
  width: 900px; /* Fixed comfortable reading width */
  margin: 0 !important;
  background: #1f1f1f;
  border: 1px solid rgba(255,255,255,0.1);
  color: #fff;
  padding: 2rem;
  border-radius: 12px;
}

/* 5. REMARK BOX - Updated to match Sidebar Theme */
.remark-box {
  margin-top: 0;
  padding: 1.2rem 1.5rem;
  border-radius: 12px;
  background: #1f1f1f; /* Matching Dark Theme */
  color: #fff;
  border: 1px solid rgba(255,255,255,0.15);
  text-align: justify;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.remark-box h3 { margin-top: 0; color: #ffa347; font-size: 1.2rem; margin-bottom: 10px; }
.remark-box ul { list-style: disc; padding-left: 1.4rem; margin: 0; }
.remark-box li { margin: 0.5rem 0; line-height: 1.4rem; font-size: 0.9rem; color: #ccc; }
.remark-box span.matched { color: #4ae27e; font-weight: 600; }
.remark-box span.almost { color: #ffd966; font-weight: 600; }
.remark-box span.missing { color: #ff7b00; font-weight: 600; }

/* 6. PROCESSING OVERLAY (Updated Size) */
#processingOverlay { display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.45); align-items: center; justify-content: center; padding: 20px; }

.processing-box {
    background: #ffffff;
    color: #111;
    /* Increased Size and Padding */
    padding: 40px 50px;
    border-radius: 12px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.3);
    font-family: inherit;
    font-size: 18px;
    display: flex;
    gap: 25px;
    align-items: center;
    /* Wider Box */
    min-width: 650px;
    max-width: 950px;
    border-left: 8px solid #ff9500;
}

.processing-text { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; }
.processing-title { font-weight: 700; font-size: 22px; color: #222; line-height: 1.1; }
.processing-sub { font-size: 15px; color: #555; }
.processing-spinner { width: 40px; height: 40px; border: 5px solid #e9ecef; border-top-color: #ff9500; border-radius: 50%; animation: spin 1s linear infinite; flex: 0 0 auto; box-shadow: 0 3px 8px rgba(0,0,0,0.08); }

@keyframes spin { to { transform: rotate(360deg); } }

/* Responsive Handling */
@media (max-width: 1400px) {
  .main-layout-wrapper {
    flex-direction: column;
    align-items: center;
    width: 100%;
    left: 0;
    transform: none;
  }

  .consolidation-sidebar, .remarks-sidebar {
    width: 100%;
    max-width: 900px;
    flex-direction: row; /* Arrange boxes side-by-side on top/bottom */
    margin-bottom: 20px;
  }

  .consolidation-box, .remark-box { flex: 1; }
  section.panel { width: 100%; max-width: 900px; order: -1; /* Keep panel? Or put sidebars first? Default order usually fine */ }
}

@media (max-width: 768px) {
  .consolidation-sidebar, .remarks-sidebar { flex-direction: column; }
  .processing-box { min-width: 300px; max-width: 92%; padding: 25px; flex-direction: column; text-align: center; }
  .processing-text { align-items: center; }
}


/* --- ORIGINAL STYLES BELOW --- */
.upload-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
.upload-actions .cta-secondary { background-color: #ffb74d; border-color: #ffb74d; color: #000; font-weight: 600; }
.upload-actions .cta-secondary:hover { background-color: #ff9800; border-color: #ff9800; }
.instruction-modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
.instruction-modal-content { background-color: #f0f0f0; color: #000; margin: auto; padding: 25px 30px; border-radius: 8px; max-width: 800px; width: 90%; position: relative; text-align: left; }
.instruction-modal-content h2 { color: #000; margin-top: 0; }
.instruction-modal-content h3 { color: #333; margin-top: 1.2rem; }
.instruction-modal-content p, .instruction-modal-content ul { line-height: 1.6; text-align: justify; }
.instruction-modal-content ul { list-style: disc; padding-left: 20px; text-align: left; }
.instruction-modal-content hr { border: none; border-top: 1px solid #ccc; margin: 1rem 0; }
.instruction-modal-close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
.instruction-modal-close-btn:hover { color: #000; }
.instruction-modal-close-cta { display: block; margin: 1.5rem auto 0; padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; background-color: #ffc107; color: #000; font-weight: bold; }
.upload-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
.upload-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 1.2rem 1.5rem; text-align: center; }
.upload-confirm { margin: .4rem 0 0; min-height: 1.2em; font-size: .92rem; color: #fff; }
.format-selector-box { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 2rem; text-align: center; }
.format-selector-box h4 { margin: 0 0 0.25rem 0; font-size: 1.1rem; color: #fff; }
.format-selector-box .hint { margin-top: 0; font-size: 0.9rem; }
.format-selector-box .radio-group { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; }
.format-selector-box .radio-group label { display: block; padding: 0.8rem 1.2rem; background: rgba(0,0,0,0.25); border-radius: 6px; cursor: pointer; transition: background 0.2s; font-size: 0.9rem; color: #fff; }
.format-selector-box .radio-group label:hover { background: rgba(0,0,0,0.4); }
.format-selector-box .radio-group input[type="radio"] { margin-right: 0.5rem; vertical-align: middle; }
</style>

<script>
  // 1. File Name Display Logic
  const f2b = document.getElementById('file2b');
  const fpr = document.getElementById('filepr');
  const n2b = document.getElementById('file2bName');
  const npr = document.getElementById('fileprName');

  function showName(input, labelEl) {
    if (input.files && input.files.length) {
      labelEl.textContent = input.files[0].name;
    } else {
      labelEl.textContent = '';
    }
  }
  if(f2b) f2b.addEventListener('change', () => showName(f2b, n2b));
  if(fpr) fpr.addEventListener('change', () => showName(fpr, npr));

  // Helper function to update consolidation labels
  function updateFileCount(input) {
      const display = input.parentElement.nextElementSibling;
      if (input.files && input.files.length > 0) {
          display.textContent = input.files.length + " files selected";
      } else {
          display.textContent = "";
      }
  }

  // --- Reset Function called by Close Button ---
  function closeConsolidationOverlay() {
      // 1. Hide Overlay
      const overlay = document.getElementById('processingOverlay');
      overlay.style.display = 'none';
      document.body.style.overflow = '';

      // 2. Reset Spinner and Button state for next time
      document.getElementById('proc-spinner').style.display = 'block';
      document.getElementById('proc-close-container').style.display = 'none';
      document.getElementById('proc-stats').style.display = 'none';

      // 3. Reset Forms and File Inputs
      document.getElementById('form-2b').reset();
      document.getElementById('form-pr').reset();

      // 4. Clear the "X files selected" text labels
      document.querySelectorAll('.consolidation-box .upload-confirm').forEach(p => {
          p.textContent = "";
      });
  }

  // --- MODAL HELPERS ---
  let pendingForm = null;

  function openMessageModal(title, text) {
      document.getElementById('msg-modal-title').innerText = title;
      document.getElementById('msg-modal-text').innerText = text;
      document.getElementById('message-modal').style.display = 'flex';
  }

  function openConfirmModal(text, form) {
      document.getElementById('conf-modal-text').innerText = text;
      document.getElementById('confirmation-modal').style.display = 'flex';
      pendingForm = form;
  }

  function closeAllModals() {
      document.getElementById('message-modal').style.display = 'none';
      document.getElementById('confirmation-modal').style.display = 'none';
      const valModal = document.getElementById('validation-modal');
      if (valModal) valModal.style.display = 'none';
      pendingForm = null;
  }

  // --- Main Handle Consolidate Function ---
  function handleConsolidation(event, form) {
      event.preventDefault(); // Stop default submission

      // 1. Auth Check
      const isLoggedIn = {{ 'true' if session.get('logged_in') else 'false' }};
      const isSubscribed = {{ 'true' if is_active_subscriber|default(false) else 'false' }};

      if (!isLoggedIn || !isSubscribed) {
          openMessageModal("Access Restricted", "Login and Subscribe to consolidate.");
          return;
      }

      // 2. File Check
      const fileInput = form.querySelector('input[type="file"]');
      if (!fileInput || fileInput.files.length === 0) {
          openMessageModal("Files Missing", "No files are uploaded.");
          return;
      }

      // 3. Trigger Custom Confirmation Modal
      openConfirmModal("Ensure the no. of columns and column headings are identical in each file for the purpose of consolidation.", form);
  }

  // --- Async Execution (Called after Confirm OK) ---
  async function executeConsolidation() {
      if (!pendingForm) return;
      const form = pendingForm;
      const fileInput = form.querySelector('input[type="file"]');

      // --- START PROCESSING UI ---
      const overlay = document.getElementById('processingOverlay');
      const title = document.getElementById('proc-title');
      const sub = document.getElementById('proc-sub');
      const stats = document.getElementById('proc-stats');
      const spinner = document.getElementById('proc-spinner');
      const closeContainer = document.getElementById('proc-close-container');

      spinner.style.display = 'block';
      closeContainer.style.display = 'none';
      stats.style.display = 'block';

      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';

      title.textContent = "Consolidation in Progress";
      sub.textContent = "Reading files and verifying structure...";
      stats.innerHTML = '<p>Reading file data...</p>';

      // --- READ FILES CLIENT-SIDE TO COUNT ROWS ---
      const files = Array.from(fileInput.files);
      let totalRows = 0;
      let fileStatsHtml = '<ul style="padding-left: 20px; margin: 0; line-height: 1.6;">';

      try {
          for (let file of files) {
              const data = await file.arrayBuffer();
              const workbook = XLSX.read(data);

              let maxRowsInFile = 0;
              workbook.SheetNames.forEach(sheetName => {
                  const worksheet = workbook.Sheets[sheetName];
                  if (!worksheet['!ref']) return;
                  const range = XLSX.utils.decode_range(worksheet['!ref']);
                  let rowCount = range.e.r - range.s.r;
                  if (rowCount < 0) rowCount = 0;
                  if (rowCount > maxRowsInFile) maxRowsInFile = rowCount;
              });

              totalRows += maxRowsInFile;
              fileStatsHtml += `<li><strong>${file.name}</strong>: ${maxRowsInFile} rows</li>`;
          }
      } catch (err) {
          console.error("Error reading files:", err);
          fileStatsHtml += `<li style="color:#e74c3c;">Error reading file details. Proceeding with server check.</li>`;
      }

      fileStatsHtml += '</ul>';
      fileStatsHtml += `<div style="margin-top:15px; font-weight:bold; border-top:1px solid #ccc; padding-top:10px;">
                          Total Rows in Consolidated File (Expected): ${totalRows}<br>
                          Gap Value: 0
                        </div>`;

      stats.innerHTML = fileStatsHtml;
      sub.textContent = "Sending data to server & generating file...";

      // --- SUBMIT TO SERVER ---
      const formData = new FormData(form);

      try {
          const response = await fetch(form.action, {
              method: 'POST',
              body: formData
          });

          if (response.ok) {
              let filename = "consolidated.xlsx";
              const disposition = response.headers.get('Content-Disposition');
              if (disposition && disposition.indexOf('attachment') !== -1) {
                  const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                  const matches = filenameRegex.exec(disposition);
                  if (matches != null && matches[1]) {
                      filename = matches[1].replace(/['"]/g, '');
                  }
              }

              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              a.remove();

              spinner.style.display = 'none';
              title.textContent = "Consolidation Complete";
              sub.textContent = "File downloaded successfully.";
              closeContainer.style.display = 'block';

          } else {
              const text = await response.text();
              if (text.includes("<!doctype html>") || response.redirected) {
                  window.location.reload();
              } else {
                  // Use our new modal instead of alert
                  closeConsolidationOverlay();
                  openMessageModal("Error", "Error during consolidation: " + response.statusText);
              }
          }
      } catch (error) {
          console.error("Submission error:", error);
          closeConsolidationOverlay();
          openMessageModal("Error", "An error occurred while connecting to the server.");
      }
  }

  // 2. Consolidated Modal & Form Handling Script
  document.addEventListener('DOMContentLoaded', () => {
    // --- Modal References ---
    const instModal = document.getElementById('instruction-modal');
    const customModal = document.getElementById('custom-format-modal');
    const valModal = document.getElementById('validation-modal');
    const msgModal = document.getElementById('message-modal');
    const confModal = document.getElementById('confirmation-modal');

    // --- Open Buttons ---
    const instBtn = document.getElementById('instruction-btn');
    const customBtn = document.getElementById('custom-format-btn');

    // --- Event Listeners for Opening Modals ---
    if (instBtn) instBtn.addEventListener('click', () => { if(instModal) instModal.style.display = 'flex'; });
    if (customBtn) customBtn.addEventListener('click', () => { if(customModal) customModal.style.display = 'flex'; });

    // --- Event Listeners for Closing Modals (X buttons and OK buttons) ---
    const allCloseBtns = document.querySelectorAll('.instruction-modal-close-btn, .instruction-modal-close-cta');
    allCloseBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            closeAllModals();
            if (instModal) instModal.style.display = 'none';
            if (customModal) customModal.style.display = 'none';
            if (valModal) valModal.style.display = 'none';
        });
    });

    // --- Special Confirm Modal Buttons ---
    const confCancel = document.getElementById('conf-modal-cancel-btn');
    const confOK = document.getElementById('conf-modal-ok-btn');

    if (confCancel) confCancel.addEventListener('click', closeAllModals);
    if (confOK) confOK.addEventListener('click', () => {
        closeAllModals();
        executeConsolidation();
    });

    // --- Close Modals on Click Outside ---
    window.addEventListener('click', (event) => {
      if (instModal && event.target === instModal) instModal.style.display = 'none';
      if (customModal && event.target === customModal) customModal.style.display = 'none';
      if (valModal && event.target === valModal) valModal.style.display = 'none';
      if (msgModal && event.target === msgModal) msgModal.style.display = 'none';
      if (confModal && event.target === confModal) confModal.style.display = 'none';
    });

    // --- FORM SUBMISSION (Main Recon) ---
    const form = document.querySelector('.upload-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const file2bInput = document.getElementById('file2b');
            const filePrInput = document.getElementById('filepr');
            if (!file2bInput.value || !filePrInput.value) {
                e.preventDefault(); e.stopPropagation();
                if (valModal) valModal.style.display = 'flex';
                return false;
            }
            const overlay = document.getElementById('processingOverlay');
            if (overlay) {
                document.getElementById('proc-title').textContent = "Column mapping between 2B and Purchase Register in Progress";
                document.getElementById('proc-sub').textContent = "Please wait — this operation may take a few seconds. The page will update automatically when ready.";
                document.getElementById('proc-stats').style.display = 'none';
                document.getElementById('proc-close-container').style.display = 'none';
                document.getElementById('proc-spinner').style.display = 'block';

                overlay.style.display = 'flex';
                overlay.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
            }
        });
    }
  });
</script>
{% endblock %}
