<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reconciliation progress</title>
  <style>
    :root {
      --bg:#0f1115; --card:#161a22; --text:#e6e8ee; --muted:#9aa3b2;
      --bar-bg:#2a3140; --bar:#4f8cff; --ok:#23c55e; --err:#ef4444;
    }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
           background:var(--bg); color:var(--text); display:grid; place-items:center; min-height:100vh; }
    .card { width:min(720px, 92vw); background:var(--card); border-radius:16px; padding:24px 24px 20px; box-shadow: 0 10px 30px rgb(0 0 0 / 35%); }

    h1 { margin:0 0 6px; font-size:20px; font-weight:650; letter-spacing:.2px; }
    p.sub { margin:0 0 16px; color:var(--muted); }

    .status-row { display:flex; align-items:center; gap:12px; margin:10px 0 14px; }
    .pill { font-size:12px; padding:4px 10px; border-radius:999px; background:#1e2633; color:#C5D1E5; }

    /* Spinner */
    .spin { width:18px; height:18px; border-radius:50%;
            border:3px solid #2a3140; border-top-color:var(--bar); animation: spin 0.85s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .msg { color:var(--muted); font-size:14px; }

    /* Progress bar with animated stripes while active */
    .bar { position:relative; height:12px; width:100%; background:var(--bar-bg); border-radius:999px; overflow:hidden; }
    .bar > span { position:relative; display:block; height:100%; width:0%; background:var(--bar); transition:width .5s ease; }
    .bar.active > span::after {
      content:""; position:absolute; inset:0; background:linear-gradient(120deg, #ffffff33 25%, transparent 25%, transparent 50%, #ffffff33 50%, #ffffff33 75%, transparent 75%, transparent);
      background-size: 24px 12px; animation: move 0.9s linear infinite;
      border-radius:inherit;
    }
    @keyframes move { from { transform: translateX(0); } to { transform: translateX(24px); } }

    .pct { font-variant-numeric: tabular-nums; font-weight:600; width:48px; text-align:right; }
    .row { display:flex; align-items:center; gap:12px; }

    .hidden { display:none; }
    .footer { margin-top:14px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:13px; }
    a.btn { background:#1f2937; color:#e6e8ee; text-decoration:none; padding:8px 12px; border-radius:10px; }
  </style>
</head>
<body>
  <div class="card">
    <!-- Change these lines to whatever wording you prefer -->
    <h1 id="title">Reconciliation started</h1>
    <p class="sub" id="subtitle">We’re processing your files. This page updates automatically.</p>

    <div class="status-row">
      <div id="spinner" class="spin" aria-hidden="true"></div>
      <span class="pill" id="statePill">started</span>
      <span class="msg" id="liveMsg">Crunching rows in the background…</span>
    </div>

    <div class="row" style="margin-bottom:8px;">
      <div id="bar" class="bar active"><span id="barFill"></span></div>
      <div class="pct" id="pctText">0%</div>
    </div>

    <div class="footer">
      <span id="hint">Please keep this tab open.</span>
      <a id="downloadBtn" class="btn hidden" href="#">Download result</a>
    </div>
  </div>

  <script>
    (function () {
      const jobId = "{{ job_id }}";
      const bar = document.getElementById("bar");
      const pctText = document.getElementById("pctText");
      const barFill = document.getElementById("barFill");
      const statePill = document.getElementById("statePill");
      const liveMsg  = document.getElementById("liveMsg");
      const dlBtn    = document.getElementById("downloadBtn");
      const hint     = document.getElementById("hint");
      const spinner  = document.getElementById("spinner");

      let lastPct = 0;
      function update(pct, msg, state){
        pct = Math.max(0, Math.min(100, parseInt(pct || 0, 10)));
        if (pct !== lastPct) {
          pctText.textContent = pct + "%";
          barFill.style.width = pct + "%";
          lastPct = pct;
        }
        if (msg)   liveMsg.textContent = msg;
        if (state) statePill.textContent = state;
      }

      async function tick(){
        try{
          const r = await fetch(`/status/${jobId}`, { cache: "no-store" });
          if(!r.ok) throw new Error("status " + r.status);
          const j = await r.json();
          const state = j.state || "queued";
          const prog  = j.progress || {};
          update(prog.pct, prog.msg, state);

          if (state === "finished"){
            spinner.classList.add("hidden");
            bar.classList.remove("active");
            statePill.textContent = "finished";
            hint.textContent = "Your file is ready.";
            dlBtn.classList.remove("hidden");
            dlBtn.href = `/download/${jobId}`;
            // optional auto-download:
            window.location.href = `/download/${jobId}`;
            return;
          }
          if (state === "failed"){
            spinner.classList.add("hidden");
            bar.classList.remove("active");
            statePill.textContent = "failed";
            statePill.style.background = "#ef4444";
            hint.textContent = "The job failed. Please try again.";
            console.error(j.error || "Job failed");
            return;
          }
        }catch(e){ console.error(e); }
        setTimeout(tick, 1200);
      }
      tick();
    })();
  </script>
</body>
</html>
