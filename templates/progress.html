{% extends "base.html" %}

{% block content %}
<style>
    .progress-wrapper {
        width: max-content;       /* Auto-stretch to fit content */
        min-width: 950px;         /* Minimum width */
        margin: 40px auto;
        background: #fff;
        border-radius: 12px;
        padding: 30px 40px;       /* Increased padding */
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        border: 2px solid #ddd;   /* Thicker border */
    }

    /* Animated Loading Section */
    .loading-container {
        text-align: center;
        padding: 40px 20px;
    }

    .spinner-ring {
        display: inline-block;
        width: 60px;              /* Slightly larger */
        height: 60px;
        border: 6px solid #f3f3f3;
        border-radius: 50%;
        border-top: 6px solid #ffad33; /* Orange color */
        animation: spin 1s linear infinite;
        margin-bottom: 25px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .loading-title {
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
    }

    .status-msg { font-size: 1.1rem; color: #555; margin-bottom: 5px; }
    .pct-text { font-size: 2rem; font-weight: 800; color: #333; }

    .progress-bar-bg {
        height: 10px;
        background: #eee;
        border-radius: 5px;
        overflow: hidden;
        margin: 20px auto;
        width: 600px; /* Fixed width for the bar so it looks good */
        max-width: 90%;
    }
    .progress-bar-fill {
        height: 100%;
        background: #ffad33; /* Orange fill */
        width: 0%;
        transition: width 0.4s;
    }

    /* Dashboard Table Styles */
    #dashboard-area { display: none; margin-top: 10px; }

    .dash-header {
        background-color: #FCE4D6;
        color: #000;
        font-weight: bold;
        text-align: center;
        padding: 10px;
        border: 1px solid #ccc;
    }
    .dash-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        margin-top: 15px;
        white-space: nowrap;
    }
    .dash-table th, .dash-table td {
        border: 1px solid #ccc;
        padding: 10px 15px;
        text-align: right;
    }
    .dash-table th.left-align { text-align: left; }
    .dash-table tr.total-row { font-weight: bold; background-color: #f9f9f9; }

    /* Row Count Cards */
    .count-container {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }
    .count-card {
        background: #f8f9fa;
        padding: 15px 25px;
        border-radius: 8px;
        border: 1px solid #ddd;
        text-align: center;
        min-width: 150px;
    }
    .count-val { display: block; font-size: 1.4rem; font-weight: bold; color: #000; }
    .count-lbl { font-size: 0.85rem; color: #666; text-transform: uppercase; }

    .btn-download {
        display: inline-block;
        background: #000;
        color: #fff;
        padding: 12px 30px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: bold;
        margin-top: 20px;
    }
    .btn-download:hover { background: #333; }
</style>

<div style="text-align: center;"> <!-- Centering Wrapper -->
    <div class="progress-wrapper" style="text-align: left;">

        <!-- Loading State -->
        <div id="loading-state" class="loading-container">
            <h2 class="loading-title">Reconciliation in Progress</h2>
            <div class="spinner-ring"></div>

            <div id="status-text" class="status-msg">Initializing...</div>

            <div class="progress-bar-bg">
                <div id="bar-fill" class="progress-bar-fill"></div>
            </div>

            <div id="pct-display" class="pct-text">0%</div>
            <p style="color:#888; font-size: 0.9rem; margin-top: 10px;">Please keep this tab open.</p>
        </div>

        <!-- Results State -->
        <div id="dashboard-area">
            <h2 style="text-align:center; margin-bottom:20px;">Reconciliation Complete</h2>

            <div class="count-container">
                <div class="count-card">
                    <span class="count-val" id="cnt-pr">0</span>
                    <span class="count-lbl">Rows in PR</span>
                </div>
                <div class="count-card">
                    <span class="count-val" id="cnt-b2b">0</span>
                    <span class="count-lbl">Rows in 2B (B2B)</span>
                </div>
                <div class="count-card">
                    <span class="count-val" id="cnt-cdnr">0</span>
                    <span class="count-lbl">Rows in 2B (CDNR)</span>
                </div>
            </div>

            <div style="overflow-x:auto;">
                <table class="dash-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="left-align dash-header">Status</th>
                            <th colspan="4" class="dash-header">PR Side</th>
                            <th colspan="4" class="dash-header">GSTR 2B Side</th>
                        </tr>
                        <tr style="background:#fff;">
                            <th>CGST</th><th>SGST</th><th>IGST</th><th>Total</th>
                            <th>CGST</th><th>SGST</th><th>IGST</th><th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="dash-body">
                        <!-- Javascript will populate rows here -->
                    </tbody>
                </table>
            </div>

            <div style="text-align:center;">
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <a href="#" id="dl-btn" class="btn-download">Download Full Report</a>
                    <a href="#" id="dl-btn-nm" class="btn-download" style="background: #ff4d4f;">Download "Not Matched" Only</a>
                </div>
                <br><br>
                <a href="{{ url_for('history') }}" style="color:#666; text-decoration:underline;">Go to History</a>
            </div>
        </div>
    </div>
</div>

<script>
    const jobId = "{{ job_id }}";
    const loader = document.getElementById('loading-state');
    const dashboard = document.getElementById('dashboard-area');
    const bar = document.getElementById('bar-fill');
    const pct = document.getElementById('pct-display');
    const msg = document.getElementById('status-text');
    const tbody = document.getElementById('dash-body');
    const dlBtn = document.getElementById('dl-btn');

    // Number Formatter (Indian Currency)
    const fmt = new Intl.NumberFormat('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    async function poll() {
        try {
            const r = await fetch(`/status/${jobId}`);
            if(!r.ok) throw new Error("Net err");
            const d = await r.json();
            const p = d.progress || {pct:0, msg:"Connecting..."};

            bar.style.width = p.pct + "%";
            pct.innerText = p.pct + "%";
            msg.innerText = p.msg;

            if (d.state === "finished") {
                if(d.result && d.result.dashboard_stats) {
                    renderDashboard(d.result.dashboard_stats);
                }

                // Set links for both buttons
                dlBtn.href = `/download/${jobId}`;
                document.getElementById('dl-btn-nm').href = `/download_nm/${jobId}`;

                loader.style.display = 'none';
                dashboard.style.display = 'block';
                return;
            }

            if (d.state === "failed") {
                msg.innerText = "Failed. Please try again.";
                msg.style.color = "red";
                document.querySelector('.spinner-ring').style.borderColor = "red";
                return;
            }

            setTimeout(poll, 1000);
        } catch(e) { console.error(e); setTimeout(poll, 2000); }
    }

    function renderDashboard(data) {
        // 1. Update Counts
        if(data.counts) {
            document.getElementById('cnt-pr').innerText = data.counts.pr || 0;
            document.getElementById('cnt-b2b').innerText = data.counts.b2b || 0;
            document.getElementById('cnt-cdnr').innerText = data.counts.cdnr || 0;
        }

        // 2. Build Table
        if(!data.table) return;
        let html = "";
        data.table.forEach(row => {
            const isTotal = row.status === "Total";
            const style = isTotal ? 'class="total-row"' : '';

            html += `<tr ${style}>
                <td class="left-align"><strong>${row.status || 'Total'}</strong></td>
                <td>${fmt.format(row.pr.cgst)}</td>
                <td>${fmt.format(row.pr.sgst)}</td>
                <td>${fmt.format(row.pr.igst)}</td>
                <td><strong>${fmt.format(row.pr.total)}</strong></td>
                <td>${fmt.format(row.b2b.cgst)}</td>
                <td>${fmt.format(row.b2b.sgst)}</td>
                <td>${fmt.format(row.b2b.igst)}</td>
                <td><strong>${fmt.format(row.b2b.total)}</strong></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    poll();
</script>
{% endblock %}
