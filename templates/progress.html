<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reconciliation Progress</title>
  <style>
    :root {
      --bg: #0b0f1a;
      --card: #121827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --accent-dim: #16a34a;
      --ring: rgba(34,197,94,.25);
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { min-height:100%; display:grid; place-items:center; padding:24px; }
    .card {
      width: min(520px, 92vw);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding: 24px 22px;
    }
    .title { font-size: 1.1rem; font-weight: 600; margin: 0 0 8px; }
    .subtitle { color: var(--muted); font-size: .925rem; margin: 0 0 18px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 10px 0; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.06);
      color: var(--muted); border-radius: 999px; padding:6px 12px; font-size:.85rem;
    }
    .spinner {
      width:14px; height:14px; border:2px solid var(--muted); border-top-color: var(--accent);
      border-radius:50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .bar {
      position: relative; width: 100%; height: 12px; background: rgba(255,255,255,.08);
      border-radius: 999px; overflow: hidden; outline: 1px solid rgba(255,255,255,.06);
    }
    .bar > .fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-dim));
      box-shadow: 0 0 0 6px var(--ring) inset;
      transition: width .35s ease;
    }
    .percent { font-variant-numeric: tabular-nums; font-weight:600; }

    .note { color: var(--muted); font-size: .9rem; margin-top: 14px; }

    /* Final dialog */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.5);
      display: none; align-items: center; justify-content: center; z-index: 50;
    }
    .modal {
      width: min(420px, 90vw);
      background: #0f172a; border:1px solid rgba(255,255,255,.08); border-radius: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.5);
      padding: 20px;
      text-align:center;
    }
    .btn {
      appearance: none; border:0; outline:0; cursor:pointer;
      background: var(--accent); color:#08130b; font-weight:700;
      padding:10px 16px; border-radius:10px; margin-top: 14px;
    }
    .btn:hover { background: var(--accent-dim); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card" data-job-id="{{ job_id }}">
      <div class="row">
        <div class="title">Reconciliation started</div>
        <span class="pill"><span class="spinner"></span> <span id="state">queued</span></span>
      </div>
      <p class="subtitle">We’re processing your files in the background. This page will update automatically.</p>

      <div class="row" style="margin-top:6px;">
        <div class="percent" id="percent">0%</div>
      </div>
      <div class="bar" aria-label="Progress">
        <div class="fill" id="fill" style="width:0%"></div>
      </div>

      <p class="note" id="note">Waiting for a worker to pick up your job…</p>
    </div>
  </div>

  <!-- Invisible target for download so we don't navigate away -->
  <iframe id="dl" style="display:none;"></iframe>

  <!-- Final modal -->
  <div class="modal-backdrop" id="doneModal">
    <div class="modal">
      <h3 style="margin:0 0 8px;">Downloaded</h3>
      <p class="subtitle" style="margin:0 0 12px;">Your reconciliation file has been downloaded.</p>
      <button class="btn" id="okBtn">OK</button>
    </div>
  </div>

  <script>
    (function () {
      const elCard = document.getElementById('card');
      const jobId = elCard.getAttribute('data-job-id');
      const elState = document.getElementById('state');
      const elPercent = document.getElementById('percent');
      const elFill = document.getElementById('fill');
      const elNote = document.getElementById('note');
      const doneModal = document.getElementById('doneModal');
      const okBtn = document.getElementById('okBtn');
      const dlFrame = document.getElementById('dl');

      const STATUS_URL = `/status/${jobId}`;
      const DOWNLOAD_URL = `/download/${jobId}`;

      let finished = false;
      let pollMs = 1500;

      async function getStatus() {
        try {
          const res = await fetch(STATUS_URL, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
          if (!res.ok) throw new Error('bad status');
          // Expect JSON like: {state: "queued|started|finished|failed", progress: 0-100, message?: "" }
          const data = await res.json();
          return data;
        } catch (e) {
          // Fallback: try text and derive something minimal
          const res = await fetch(STATUS_URL + '?t=' + Date.now(), { cache: 'no-store' });
          const txt = await res.text();
          // naive parse e.g. "0% - queued"
          const m = txt.match(/(\d+)%.*(queued|started|finished|failed)/i);
          const pct = m ? parseInt(m[1], 10) : 0;
          const st = m ? m[2].toLowerCase() : 'queued';
          return { state: st, progress: pct, message: txt };
        }
      }

      function render({ state, progress, message }) {
        elState.textContent = state;
        elPercent.textContent = `${progress|0}%`;
        elFill.style.width = `${Math.max(0, Math.min(100, progress|0))}%`;

        if (state === 'queued') {
          elNote.textContent = 'Waiting for a worker to pick up your job…';
        } else if (state === 'started' || state === 'processing' || state === 'working') {
          elNote.textContent = 'Crunching rows in the background…';
        } else if (state === 'finished' || state === 'complete' || progress >= 100) {
          elNote.textContent = 'Preparing your download…';
        } else if (state === 'failed') {
          elNote.textContent = (message || 'Job failed. Please try again.');
        }
      }

      async function tick() {
        if (finished) return;
        const st = await getStatus();
        render(st);

        if ((st.state === 'finished' || st.state === 'complete' || (st.progress|0) >= 100) && !finished) {
          finished = true;
          // Trigger download without leaving the page
          dlFrame.src = DOWNLOAD_URL;

          // Give the browser a moment to start the download, then show the final modal
          setTimeout(() => { doneModal.style.display = 'flex'; }, 900);
          return;
        }

        if (st.state === 'failed') {
          elNote.style.color = '#fca5a5';
          return; // stop polling on failure
        }

        setTimeout(tick, pollMs);
      }

      okBtn.addEventListener('click', () => {
        window.location.href = '/';
      });

      tick();
    })();
  </script>
</body>
</html>
