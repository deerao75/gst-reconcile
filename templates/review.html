<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Review Matches</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .review-wrapper {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 90vh; /* Full height window */
        }
        .header-panel { padding: 20px; border-bottom: 1px solid #ddd; }

        /* Excel-like Table Container */
        .table-container {
            flex: 1;
            overflow: auto; /* Enable both horizontal and vertical scroll */
            position: relative;
            border-bottom: 1px solid #ddd;
        }

        table {
            border-collapse: collapse;
            width: max-content; /* Ensure table stretches to fit columns */
            font-size: 13px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            white-space: nowrap; /* Prevent wrapping like Excel */
        }

        /* Sticky Header */
        thead th {
            position: sticky;
            top: 0;
            background-color: #e9ecef;
            z-index: 2;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
        }

        /* Sticky First Column (Checkbox) */
        tbody td:first-child, thead th:first-child {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            z-index: 3;
            border-right: 2px solid #ccc;
        }

        /* Highlight specific columns if needed */
        .col-mapping { background-color: #fff3cd; font-weight: bold; }

        /* NEW: Right-align numeric cells + tabular numbers */
        td.num {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .footer-panel { padding: 20px; text-align: right; background: #f8f9fa; border-radius: 0 0 8px 8px; }
    </style>
</head>
<body>

<div class="review-wrapper">
    <form action="{{ url_for('submit_review') }}" method="POST" id="reviewForm" style="display:contents;">
        <input type="hidden" name="pickle_id" value="{{ pickle_id }}">

        <div class="header-panel">
            <h3>Review "Almost Matched" Transactions</h3>
            <p class="text-muted mb-2">
                Check the boxes for transactions you want to <b>Accept (Match)</b>.
                Any unchecked transactions will be marked as <b>Not Matched</b>.
            </p>
            <div>
                <button type="button" class="btn btn-sm btn-primary" onclick="toggleAll(true)">Select All</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAll(false)">Deselect All</button>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 50px;">
                            <input type="checkbox" onclick="toggleAll(this.checked)">
                        </th>
                        {% for col in columns %}
                            {% if col != 'id' and not col.startswith('_') %}
                                <th>{{ col }}</th>
                            {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                    <tr>
                        <td class="text-center">
                            <input type="checkbox" name="accepted_rows" value="{{ row.id }}" class="row-cb">
                        </td>
                        {% for col in columns %}
                            {% if col != 'id' and not col.startswith('_') %}
                                <td data-col="{{ col }}">{{ row[col] }}</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="footer-panel">
            <span class="text-muted me-3" id="sel-count">0 selected</span>
            <button type="submit" class="btn btn-success px-5">Confirm & Finalize Report</button>
        </div>
    </form>
</div>

<script>
    const checkboxes = document.querySelectorAll('.row-cb');
    const countSpan = document.getElementById('sel-count');

    function toggleAll(checked) {
        checkboxes.forEach(cb => cb.checked = checked);
        updateCount();
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateCount);
    });

    function updateCount() {
        const checkedCount = document.querySelectorAll('.row-cb:checked').length;
        countSpan.innerText = checkedCount + " selected (will be Matched)";
    }

    // NEW: Detect numeric columns and format to 2 decimals + right-align
    // Heuristic: column name contains tax/value/amount/cgst/sgst/igst/cess/total
    const numericNameRe = /(tax|amount|value|cgst|sgst|igst|cess|total)/i;

    function parseNumberStrict(s) {
        if (s == null) return null;
        const t = String(s).trim();
        if (!t) return null;
        // remove commas
        const cleaned = t.replace(/,/g, '');
        // allow negative and decimals
        if (!/^[-+]?\d+(\.\d+)?$/.test(cleaned)) return null;
        const n = Number(cleaned);
        return Number.isFinite(n) ? n : null;
    }

    document.querySelectorAll('tbody td[data-col]').forEach(td => {
        const colName = td.getAttribute('data-col') || '';
        if (!numericNameRe.test(colName)) return;

        const n = parseNumberStrict(td.textContent);
        if (n === null) return;

        td.classList.add('num');
        td.textContent = n.toFixed(2);
    });
</script>
</body>
</html>
